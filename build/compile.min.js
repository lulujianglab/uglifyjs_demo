var jsp=require("./parse-js"),curry=jsp.curry,slice=jsp.slice,member=jsp.member,is_identifier_char=jsp.is_identifier_char,PRECEDENCE=jsp.PRECEDENCE,OPERATORS=jsp.OPERATORS;function ast_walker(){function n(n){return[this[0],MAP(n,function(n){var e=[n[0]];if(n.length>1)e[1]=u(n[1]);return e})]}function e(n){var e=[this[0]];if(n!=null)e.push(MAP(n,u));return e}var r={string:function(n){return[this[0],n]},num:function(n){return[this[0],n]},name:function(n){return[this[0],n]},toplevel:function(n){return[this[0],MAP(n,u)]},block:e,splice:e,var:n,const:n,try:function(n,e,r){return[this[0],MAP(n,u),e!=null?[e[0],MAP(e[1],u)]:null,r!=null?MAP(r,u):null]},throw:function(n){return[this[0],u(n)]},new:function(n,e){return[this[0],u(n),MAP(e,u)]},switch:function(n,e){return[this[0],u(n),MAP(e,function(n){return[n[0]?u(n[0]):null,MAP(n[1],u)]})]},break:function(n){return[this[0],n]},continue:function(n){return[this[0],n]},conditional:function(n,e,r){return[this[0],u(n),u(e),u(r)]},assign:function(n,e,r){return[this[0],n,u(e),u(r)]},dot:function(n){return[this[0],u(n)].concat(slice(arguments,1))},call:function(n,e){return[this[0],u(n),MAP(e,u)]},function:function(n,e,r){return[this[0],n,e.slice(),MAP(r,u)]},debugger:function(){return[this[0]]},defun:function(n,e,r){return[this[0],n,e.slice(),MAP(r,u)]},if:function(n,e,r){return[this[0],u(n),u(e),u(r)]},for:function(n,e,r,t){return[this[0],u(n),u(e),u(r),u(t)]},"for-in":function(n,e,r,t){return[this[0],u(n),u(e),u(r),u(t)]},while:function(n,e){return[this[0],u(n),u(e)]},do:function(n,e){return[this[0],u(n),u(e)]},return:function(n){return[this[0],u(n)]},binary:function(n,e,r){return[this[0],n,u(e),u(r)]},"unary-prefix":function(n,e){return[this[0],n,u(e)]},"unary-postfix":function(n,e){return[this[0],n,u(e)]},sub:function(n,e){return[this[0],u(n),u(e)]},object:function(n){return[this[0],MAP(n,function(n){return n.length==2?[n[0],u(n[1])]:[n[0],u(n[1]),n[2]]})]},regexp:function(n,e){return[this[0],n,e]},array:function(n){return[this[0],MAP(n,u)]},stat:function(n){return[this[0],u(n)]},seq:function(){return[this[0]].concat(MAP(slice(arguments),u))},label:function(n,e){return[this[0],n,u(e)]},with:function(n,e){return[this[0],u(n),u(e)]},atom:function(n){return[this[0],n]},directive:function(n){return[this[0],n]}};var t={};var i=[];function u(n){if(n==null)return null;try{i.push(n);var e=n[0];var u=t[e];if(u){var s=u.apply(n,n.slice(1));if(s!=null)return s}u=r[e];return u.apply(n,n.slice(1))}finally{i.pop()}}function s(n){if(n==null)return null;try{i.push(n);return r[n[0]].apply(n,n.slice(1))}finally{i.pop()}}function a(n,e){var r={},i;for(i in n)if(HOP(n,i)){r[i]=t[i];t[i]=n[i]}var u=e();for(i in r)if(HOP(r,i)){if(!r[i])delete t[i];else t[i]=r[i]}return u}return{walk:u,dive:s,with_walkers:a,parent:function(){return i[i.length-2]},stack:function(){return i}}}function Scope(n){this.names={};this.mangled={};this.rev_mangled={};this.cname=-1;this.refs={};this.uses_with=false;this.uses_eval=false;this.directives=[];this.parent=n;this.children=[];if(n){this.level=n.level+1;n.children.push(this)}else{this.level=0}}function base54_digits(){if(typeof DIGITS_OVERRIDE_FOR_TESTING!="undefined")return DIGITS_OVERRIDE_FOR_TESTING;else return"etnrisouaflchpdvmgybwESxTNCkLAOM_DPHBjFIqRUzWXV$JKQGYZ0516372984"}var base54=function(){var n=base54_digits();return function(e){var r="",t=54;do{r+=n.charAt(e%t);e=Math.floor(e/t);t=64}while(e>0);return r}}();Scope.prototype={has:function(n){for(var e=this;e;e=e.parent)if(HOP(e.names,n))return e},has_mangled:function(n){for(var e=this;e;e=e.parent)if(HOP(e.rev_mangled,n))return e},toJSON:function(){return{names:this.names,uses_eval:this.uses_eval,uses_with:this.uses_with}},next_mangled:function(){for(;;){var n=base54(++this.cname),e;e=this.has_mangled(n);if(e&&this.refs[e.rev_mangled[n]]===e)continue;e=this.has(n);if(e&&e!==this&&this.refs[n]===e&&!e.has_mangled(n))continue;if(HOP(this.refs,n)&&this.refs[n]==null)continue;if(!is_identifier(n))continue;return n}},set_mangle:function(n,e){this.rev_mangled[e]=n;return this.mangled[n]=e},get_mangled:function(n,e){if(this.uses_eval||this.uses_with)return n;var r=this.has(n);if(!r)return n;if(HOP(r.mangled,n))return r.mangled[n];if(!e)return n;return r.set_mangle(n,r.next_mangled())},references:function(n){return n&&!this.parent||this.uses_with||this.uses_eval||this.refs[n]},define:function(n,e){if(n!=null){if(e=="var"||!HOP(this.names,n))this.names[n]=e||"var";return n}},active_directive:function(n){return member(n,this.directives)||this.parent&&this.parent.active_directive(n)}};function ast_add_scope(n){var e=null;var r=ast_walker(),t=r.walk;var i=[];function u(n){e=new Scope(e);e.labels=new Scope;var r=e.body=n();r.scope=e;e=e.parent;return r}function s(n,r){return e.define(n,r)}function a(n){e.refs[n]=true}function f(n,e,r){var i=this[0]=="defun";return[this[0],i?s(n,"defun"):n,e,u(function(){if(!i)s(n,"lambda");MAP(e,function(n){s(n,"arg")});return MAP(r,t)})]}function c(n){return function(e){MAP(e,function(e){s(e[0],n);if(e[1])a(e[0])})}}function o(n){if(n)e.labels.refs[n]=true}return u(function(){var u=r.with_walkers({function:f,defun:f,label:function(n,r){e.labels.define(n)},break:o,continue:o,with:function(n,r){for(var t=e;t;t=t.parent)t.uses_with=true},var:c("var"),const:c("const"),try:function(n,e,r){if(e!=null)return[this[0],MAP(n,t),[s(e[0],"catch"),MAP(e[1],t)],r!=null?MAP(r,t):null]},name:function(n){if(n=="eval")i.push(e);a(n)}},function(){return t(n)});MAP(i,function(n){if(!n.has("eval"))while(n){n.uses_eval=true;n=n.parent}});function l(n,e){for(e=n.children.length;--e>=0;)l(n.children[e]);for(e in n.refs)if(HOP(n.refs,e)){for(var r=n.has(e),t=n;t;t=t.parent){t.refs[e]=r;if(t===r)break}}}l(e);return u})}function ast_mangle(n,e){var r=ast_walker(),t=r.walk,i;e=defaults(e,{mangle:true,toplevel:false,defines:null,except:null,no_functions:false});function u(n,r){if(!e.mangle)return n;if(!e.toplevel&&!i.parent)return n;if(e.except&&member(n,e.except))return n;if(e.no_functions&&HOP(i.names,n)&&(i.names[n]=="defun"||i.names[n]=="lambda"))return n;return i.get_mangled(n,r)}function s(n){if(e.defines){if(!i.has(n)){if(HOP(e.defines,n)){return e.defines[n]}}return null}}function a(n,r,s){if(!e.no_functions&&e.mangle){var a=this[0]=="defun",c;if(n){if(a)n=u(n);else if(s.scope.references(n)){c={};if(!(i.uses_eval||i.uses_with))n=c[n]=i.next_mangled();else c[n]=n}else n=null}}s=f(s.scope,function(){r=MAP(r,function(n){return u(n)});return MAP(s,t)},c);return[this[0],n,r,s]}function f(n,e,r){var t=i;i=n;if(r)for(var s in r)if(HOP(r,s)){n.set_mangle(s,r[s])}for(var s in n.names)if(HOP(n.names,s)){u(s,true)}var a=e();a.scope=n;i=t;return a}function c(n){return[this[0],MAP(n,function(n){return[u(n[0]),t(n[1])]})]}function o(n){if(n)return[this[0],i.labels.get_mangled(n)]}return r.with_walkers({function:a,defun:function(){var n=a.apply(this,arguments);switch(r.parent()[0]){case"toplevel":case"function":case"defun":return MAP.at_top(n)}return n},label:function(n,e){if(i.labels.refs[n])return[this[0],i.labels.get_mangled(n,true),t(e)];return t(e)},break:o,continue:o,var:c,const:c,name:function(n){return s(n)||[this[0],u(n)]},try:function(n,e,r){return[this[0],MAP(n,t),e!=null?[u(e[0]),MAP(e[1],t)]:null,r!=null?MAP(r,t):null]},toplevel:function(n){var e=this;return f(e.scope,function(){return[e[0],MAP(n,t)]})},directive:function(){return MAP.at_top(this)}},function(){return t(ast_add_scope(n))})}var warn=function(){};function best_of(n,e){return gen_code(n).length>gen_code(e[0]=="stat"?e[1]:e).length?e:n}function last_stat(n){if(n[0]=="block"&&n[1]&&n[1].length>0)return n[1][n[1].length-1];return n}function aborts(n){if(n)switch(last_stat(n)[0]){case"return":case"break":case"continue":case"throw":return true}}function boolean_expr(n){return n[0]=="unary-prefix"&&member(n[1],["!","delete"])||n[0]=="binary"&&member(n[1],["in","instanceof","==","!=","===","!==","<","<=",">=",">"])||n[0]=="binary"&&member(n[1],["&&","||"])&&boolean_expr(n[2])&&boolean_expr(n[3])||n[0]=="conditional"&&boolean_expr(n[2])&&boolean_expr(n[3])||n[0]=="assign"&&n[1]===true&&boolean_expr(n[3])||n[0]=="seq"&&boolean_expr(n[n.length-1])}function empty(n){return!n||n[0]=="block"&&(!n[1]||n[1].length==0)}function is_string(n){return n[0]=="string"||n[0]=="unary-prefix"&&n[1]=="typeof"||n[0]=="binary"&&n[1]=="+"&&(is_string(n[2])||is_string(n[3]))}var when_constant=function(){var n={};function e(r){switch(r[0]){case"string":case"num":return r[1];case"name":case"atom":switch(r[1]){case"true":return true;case"false":return false;case"null":return null}break;case"unary-prefix":switch(r[1]){case"!":return!e(r[2]);case"typeof":return typeof e(r[2]);case"~":return~e(r[2]);case"-":return-e(r[2]);case"+":return+e(r[2])}break;case"binary":var t=r[2],i=r[3];switch(r[1]){case"&&":return e(t)&&e(i);case"||":return e(t)||e(i);case"|":return e(t)|e(i);case"&":return e(t)&e(i);case"^":return e(t)^e(i);case"+":return e(t)+e(i);case"*":return e(t)*e(i);case"/":return e(t)/e(i);case"%":return e(t)%e(i);case"-":return e(t)-e(i);case"<<":return e(t)<<e(i);case">>":return e(t)>>e(i);case">>>":return e(t)>>>e(i);case"==":return e(t)==e(i);case"===":return e(t)===e(i);case"!=":return e(t)!=e(i);case"!==":return e(t)!==e(i);case"<":return e(t)<e(i);case"<=":return e(t)<=e(i);case">":return e(t)>e(i);case">=":return e(t)>=e(i);case"in":return e(t)in e(i);case"instanceof":return e(t)instanceof e(i)}}throw n}return function(r,t,i){try{var u=e(r),s;switch(typeof u){case"string":s=["string",u];break;case"number":s=["num",u];break;case"boolean":s=["name",String(u)];break;default:if(u===null){s=["atom","null"];break}throw new Error("Can't handle constant of type: "+typeof u)}return t.call(r,s,u)}catch(t){if(t===n){if(r[0]=="binary"&&(r[1]=="==="||r[1]=="!==")&&(is_string(r[2])&&is_string(r[3])||boolean_expr(r[2])&&boolean_expr(r[3]))){r[1]=r[1].substr(0,2)}else if(i&&r[0]=="binary"&&(r[1]=="||"||r[1]=="&&")){try{var a=e(r[2]);r=r[1]=="&&"&&(a?r[3]:a)||r[1]=="||"&&(a?a:r[3])||r}catch(n){}}return i?i.call(r,r):null}else throw t}}}();function warn_unreachable(n){if(!empty(n))warn("Dropping unreachable code: "+gen_code(n,true))}function prepare_ifs(n){var e=ast_walker(),r=e.walk;function t(n){n=MAP(n,r);for(var e=0;e<n.length;++e){var i=n[e];if(i[0]!="if")continue;if(i[3])continue;var u=i[2];if(!aborts(u))continue;var s=r(i[1]);var a=t(n.slice(e+1));var f=a.length==1?a[0]:["block",a];return n.slice(0,e).concat([[i[0],s,u,f]])}return n}function i(n,e,r){r=t(r);return[this[0],n,e,r]}function u(n){return[this[0],n!=null?t(n):null]}return e.with_walkers({defun:i,function:i,block:u,splice:u,toplevel:function(n){return[this[0],t(n)]},try:function(n,e,r){return[this[0],t(n),e!=null?[e[0],t(e[1])]:null,r!=null?t(r):null]}},function(){return r(n)})}function for_side_effects(n,e){var r=ast_walker(),t=r.walk;var i={},u={};function s(){throw i}function a(){throw u}function f(){return e.call(this,this,r,s,a)}function c(n){if(n=="++"||n=="--")return f.apply(this,arguments)}function o(n){if(n=="&&"||n=="||")return f.apply(this,arguments)}return r.with_walkers({try:f,throw:f,return:f,new:f,switch:f,break:f,continue:f,assign:f,call:f,if:f,for:f,"for-in":f,while:f,do:f,"unary-prefix":c,"unary-postfix":c,conditional:f,binary:o,defun:f},function(){while(true)try{t(n);break}catch(n){if(n===i)break;if(n===u)continue;throw n}})}function ast_lift_variables(n){var e=ast_walker(),r=e.walk,t;function i(n,e){var i=t;t=e;n=MAP(n,r);var u={},s=MAP(e.names,function(n,r){if(n!="var")return MAP.skip;if(!e.references(r))return MAP.skip;u[r]=true;return[r]});if(s.length>0){for_side_effects(["block",n],function(n,e,r,t){if(n[0]=="assign"&&n[1]===true&&n[2][0]=="name"&&HOP(u,n[2][1])){for(var i=s.length;--i>=0;){if(s[i][0]==n[2][1]){if(s[i][1])r();s[i][1]=n[3];s.push(s.splice(i,1)[0]);break}}var a=e.parent();if(a[0]=="seq"){var f=a[2];f.unshift(0,a.length);a.splice.apply(a,f)}else if(a[0]=="stat"){a.splice(0,a.length,"block")}else{r()}t()}r()});n.unshift(["var",s])}t=i;return n}function u(n){var r=null;for(var t=n.length;--t>=0;){var i=n[t];if(!i[1])continue;i=["assign",true,["name",i[0]],i[1]];if(r==null)r=i;else r=["seq",i,r]}if(r==null&&e.parent()[0]!="for"){if(e.parent()[0]=="for-in")return["name",n[0][0]];return MAP.skip}return["stat",r]}function s(n){return[this[0],i(n,this.scope)]}return e.with_walkers({function:function(n,e,r){for(var t=e.length;--t>=0&&!r.scope.references(e[t]);)e.pop();if(!r.scope.references(n))n=null;return[this[0],n,e,i(r,r.scope)]},defun:function(n,e,r){if(!t.references(n))return MAP.skip;for(var u=e.length;--u>=0&&!r.scope.references(e[u]);)e.pop();return[this[0],n,e,i(r,r.scope)]},var:u,toplevel:s},function(){return r(ast_add_scope(n))})}function ast_squeeze(n,e){n=squeeze_1(n,e);n=squeeze_2(n,e);return n}function squeeze_1(n,e){e=defaults(e,{make_seqs:true,dead_code:true,no_warnings:false,keep_comps:true,unsafe:false});var r=ast_walker(),t=r.walk,i;function u(n){var r=["unary-prefix","!",n];switch(n[0]){case"unary-prefix":return n[1]=="!"&&boolean_expr(n[2])?n[2]:r;case"seq":n=slice(n);n[n.length-1]=u(n[n.length-1]);return n;case"conditional":return best_of(r,["conditional",n[1],u(n[2]),u(n[3])]);case"binary":var t=n[1],i=n[2],s=n[3];if(!e.keep_comps)switch(t){case"<=":return["binary",">",i,s];case"<":return["binary",">=",i,s];case">=":return["binary","<",i,s];case">":return["binary","<=",i,s]}switch(t){case"==":return["binary","!=",i,s];case"!=":return["binary","==",i,s];case"===":return["binary","!==",i,s];case"!==":return["binary","===",i,s];case"&&":return best_of(r,["binary","||",u(i),u(s)]);case"||":return best_of(r,["binary","&&",u(i),u(s)])}break}return r}function s(n,e,r){var t=function(){if(n[0]=="unary-prefix"&&n[1]=="!"){return r?["conditional",n[2],r,e]:["binary","||",n[2],e]}else{return r?best_of(["conditional",n,e,r],["conditional",u(n),r,e]):["binary","&&",n,e]}};return when_constant(n,function(n,t){warn_unreachable(t?r:e);return t?e:r},t)}function a(n){if(n!=null&&n[0]=="block"&&n[1]){if(n[1].length==1)n=n[1][0];else if(n[1].length==0)n=["block"]}return n}function f(n,e,r){return[this[0],n,e,c(r,"lambda")]}function c(n,r){n=MAP(n,t);n=n.reduce(function(n,e){if(e[0]=="block"){if(e[1]){n.push.apply(n,e[1])}}else{n.push(e)}return n},[]);n=function(e,r){n.forEach(function(n){if(r&&(n[0]=="var"&&r[0]=="var"||n[0]=="const"&&r[0]=="const")){r[1]=r[1].concat(n[1])}else{e.push(n);r=n}});return e}([]);if(e.dead_code)n=function(r,t){n.forEach(function(n){if(t){if(n[0]=="function"||n[0]=="defun"){r.push(n)}else if(n[0]=="var"||n[0]=="const"){if(!e.no_warnings)warn("Variables declared in unreachable code");n[1]=MAP(n[1],function(n){if(n[1]&&!e.no_warnings)warn_unreachable(["assign",true,["name",n[0]],n[1]]);return[n[0]]});r.push(n)}else if(!e.no_warnings)warn_unreachable(n)}else{r.push(n);if(member(n[0],["return","throw","break","continue"]))t=true}});return r}([]);if(e.make_seqs)n=function(e,r){n.forEach(function(n){if(r&&r[0]=="stat"&&n[0]=="stat"){r[1]=["seq",r[1],n[1]]}else{e.push(n);r=n}});if(e.length>=2&&e[e.length-2][0]=="stat"&&(e[e.length-1][0]=="return"||e[e.length-1][0]=="throw")&&e[e.length-1][1]){e.splice(e.length-2,2,[e[e.length-1][0],["seq",e[e.length-2][1],e[e.length-1][1]]])}return e}([]);return n}function o(n,e,r){return when_constant(n,function(n,i){if(i){e=t(e);warn_unreachable(r);return e||["block"]}else{r=t(r);warn_unreachable(e);return r||["block"]}},function(){return h(n,e,r)})}function l(n,e,r){var i=[["if",u(n),r]];if(e[0]=="block"){if(e[1])i=i.concat(e[1])}else{i.push(e)}return t(["block",i])}function h(n,e,r){n=t(n);e=t(e);r=t(r);if(empty(r)&&empty(e))return["stat",n];if(empty(e)){n=u(n);e=r;r=null}else if(empty(r)){r=null}else{(function(){var t=gen_code(n);var i=u(n);var s=gen_code(i);if(s.length<t.length){var a=e;e=r;r=a;n=i}})()}var i=["if",n,e,r];if(e[0]=="if"&&empty(e[3])&&empty(r)){i=best_of(i,t(["if",["binary","&&",n,e[1]],e[2]]))}else if(e[0]=="stat"){if(r){if(r[0]=="stat")i=best_of(i,["stat",s(n,e[1],r[1])]);else if(aborts(r))i=l(n,e,r)}else{i=best_of(i,["stat",s(n,e[1])])}}else if(r&&e[0]==r[0]&&(e[0]=="return"||e[0]=="throw")&&e[1]&&r[1]){i=best_of(i,[e[0],s(n,e[1],r[1])])}else if(r&&aborts(e)){i=[["if",n,e]];if(r[0]=="block"){if(r[1])i=i.concat(r[1])}else{i.push(r)}i=t(["block",i])}else if(e&&aborts(r)){i=l(n,e,r)}return i}function p(n,e){return when_constant(n,function(n,r){if(!r){warn_unreachable(e);return["block"]}else{return["for",null,null,null,t(e)]}})}return r.with_walkers({sub:function(n,e){if(e[0]=="string"){var r=e[1];if(is_identifier(r))return["dot",t(n),r];else if(/^[1-9][0-9]*$/.test(r)||r==="0")return["sub",t(n),["num",parseInt(r,10)]]}},if:o,toplevel:function(n){return["toplevel",c(n)]},switch:function(n,e){var r=e.length-1;return["switch",t(n),MAP(e,function(n,e){var i=c(n[1]);if(e==r&&i.length>0){var u=i[i.length-1];if(u[0]=="break"&&!u[1])i.pop()}return[n[0]?t(n[0]):null,i]})]},function:f,defun:f,block:function(n){if(n)return a(["block",c(n)])},binary:function(n,e,r){return when_constant(["binary",n,t(e),t(r)],function n(e){return best_of(t(e),this)},function i(){return function(){if(n!="=="&&n!="!=")return;var i=t(e),u=t(r);if(i&&i[0]=="unary-prefix"&&i[1]=="!"&&i[2][0]=="num")e=["num",+!i[2][1]];else if(u&&u[0]=="unary-prefix"&&u[1]=="!"&&u[2][0]=="num")r=["num",+!u[2][1]];return["binary",n,e,r]}()||this})},conditional:function(n,e,r){return s(t(n),t(e),t(r))},try:function(n,e,r){return["try",c(n),e!=null?[e[0],c(e[1])]:null,r!=null?c(r):null]},"unary-prefix":function(n,e){e=t(e);var r=["unary-prefix",n,e];if(n=="!")r=best_of(r,u(e));return when_constant(r,function(n,e){return t(n)},function(){return r})},name:function(n){switch(n){case"true":return["unary-prefix","!",["num",0]];case"false":return["unary-prefix","!",["num",1]]}},while:p,assign:function(n,e,r){e=t(e);r=t(r);var i=["+","-","/","*","%",">>","<<",">>>","|","^","&"];if(n===true&&e[0]==="name"&&r[0]==="binary"&&~i.indexOf(r[1])&&r[2][0]==="name"&&r[2][1]===e[1]){return[this[0],r[1],e,r[3]]}return[this[0],n,e,r]},call:function(n,r){n=t(n);if(e.unsafe&&n[0]=="dot"&&n[1][0]=="string"&&n[2]=="toString"){return n[1]}return[this[0],n,MAP(r,t)]},num:function(n){if(!isFinite(n))return["binary","/",n===1/0?["num",1]:n===-1/0?["unary-prefix","-",["num",1]]:["num",0],["num",0]];return[this[0],n]}},function(){return t(prepare_ifs(t(prepare_ifs(n))))})}function squeeze_2(n,e){var r=ast_walker(),t=r.walk,i;function u(n,e){var r=i,t;i=n;t=e();i=r;return t}function s(n,e,r){return[this[0],n,e,u(r.scope,curry(MAP,r,t))]}return r.with_walkers({directive:function(n){if(i.active_directive(n))return["block"];i.directives.push(n)},toplevel:function(n){return[this[0],u(this.scope,curry(MAP,n,t))]},function:s,defun:s},function(){return t(ast_add_scope(n))})}var DOT_CALL_NO_PARENS=jsp.array_to_hash(["name","array","object","string","dot","sub","call","regexp","defun"]);function make_string(n,e){var r=0,t=0;n=n.replace(/[\\\b\f\n\r\t\x22\x27\u2028\u2029\0]/g,function(n){switch(n){case"\\":return"\\\\";case"\b":return"\\b";case"\f":return"\\f";case"\n":return"\\n";case"\r":return"\\r";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";case'"':++r;return'"';case"'":++t;return"'";case"\0":return"\\0"}return n});if(e)n=to_ascii(n);if(r>t)return"'"+n.replace(/\x27/g,"\\'")+"'";else return'"'+n.replace(/\x22/g,'\\"')+'"'}function to_ascii(n){return n.replace(/[\u0080-\uffff]/g,function(n){var e=n.charCodeAt(0).toString(16);while(e.length<4)e="0"+e;return"\\u"+e})}var SPLICE_NEEDS_BRACKETS=jsp.array_to_hash(["if","while","do","for","for-in","with"]);function gen_code(n,e){e=defaults(e,{indent_start:0,indent_level:4,quote_keys:false,space_colon:false,beautify:false,ascii_only:false,inline_script:false});var r=!!e.beautify;var t=0,i=r?"\n":"",u=r?" ":"";function s(n){var r=make_string(n,e.ascii_only);if(e.inline_script)r=r.replace(/<\x2fscript([>\/\t\n\f\r ])/gi,"<\\/script$1");return r}function a(n){n=n.toString();if(e.ascii_only)n=to_ascii(n);return n}function f(n){if(n==null)n="";if(r)n=repeat_string(" ",e.indent_start+t*e.indent_level)+n;return n}function c(n,e){if(e==null)e=1;t+=e;try{return n.apply(null,slice(arguments,1))}finally{t-=e}}function o(n){n=n.toString();return n.charAt(n.length-1)}function l(n){return n.toString().charAt(0)}function h(n){if(r)return n.join(" ");var e=[];for(var t=0;t<n.length;++t){var i=n[t+1];e.push(n[t]);if(i&&(is_identifier_char(o(n[t]))&&(is_identifier_char(l(i))||l(i)=="\\")||(/[\+\-]$/.test(n[t].toString())&&/^[\+\-]/.test(i.toString())||o(n[t])=="/"&&l(i)=="/"))){e.push(" ")}}return e.join("")}function p(n){return n.join(","+u)}function _(n){var e=w(n);for(var r=1;r<arguments.length;++r){var t=arguments[r];if(t instanceof Function&&t(n)||n[0]==t)return"("+e+")"}return e}function v(n){if(n.length==1){return n[0]}if(n.length==2){var e=n[1];n=n[0];return n.length<=e.length?n:e}return v([n[0],v(n.slice(1))])}function g(n){if(n[0]=="function"||n[0]=="object"){var e=slice(d.stack()),r=e.pop(),t=e.pop();while(t){if(t[0]=="stat")return true;if((t[0]=="seq"||t[0]=="call"||t[0]=="dot"||t[0]=="sub"||t[0]=="conditional")&&t[1]===r||(t[0]=="binary"||t[0]=="assign"||t[0]=="unary-postfix")&&t[2]===r){r=t;t=e.pop()}else{return false}}}return!HOP(DOT_CALL_NO_PARENS,n[0])}function b(n){var e=n.toString(10),r=[e.replace(/^0\./,".").replace("e+","e")],t;if(Math.floor(n)===n){if(n>=0){r.push("0x"+n.toString(16).toLowerCase(),"0"+n.toString(8))}else{r.push("-0x"+(-n).toString(16).toLowerCase(),"-0"+(-n).toString(8))}if(t=/^(.*?)(0+)$/.exec(n)){r.push(t[1]+"e"+t[2].length)}}else if(t=/^0?\.(0+)(.*)$/.exec(n)){r.push(t[2]+"e-"+(t[1].length+t[2].length),e.substr(e.indexOf(".")))}return v(r)}var d=ast_walker();var w=d.walk;return d.with_walkers({string:s,num:b,name:a,debugger:function(){return"debugger;"},toplevel:function(n){return k(n).join(i+i)},splice:function(n){var e=d.parent();if(HOP(SPLICE_NEEDS_BRACKETS,e)){return x.apply(this,arguments)}else{return MAP(k(n,true),function(n,e){return e>0?f(n):n}).join(i)}},block:x,var:function(n){return"var "+p(MAP(n,M))+";"},const:function(n){return"const "+p(MAP(n,M))+";"},try:function(n,e,r){var t=["try",x(n)];if(e)t.push("catch","("+e[0]+")",x(e[1]));if(r)t.push("finally",x(r));return h(t)},throw:function(n){return h(["throw",w(n)])+";"},new:function(n,e){e=e.length>0?"("+p(MAP(e,function(n){return _(n,"seq")}))+")":"";return h(["new",_(n,"seq","binary","conditional","assign",function(n){var e=ast_walker(),r={};try{e.with_walkers({call:function(){throw r},function:function(){return this}},function(){e.walk(n)})}catch(n){if(n===r)return true;throw n}})+e])},switch:function(n,e){return h(["switch","("+w(n)+")",A(e)])},break:function(n){var e="break";if(n!=null)e+=" "+a(n);return e+";"},continue:function(n){var e="continue";if(n!=null)e+=" "+a(n);return e+";"},conditional:function(n,e,r){return h([_(n,"assign","seq","conditional"),"?",_(e,"seq"),":",_(r,"seq")])},assign:function(n,e,r){if(n&&n!==true)n+="=";else n="=";return h([w(e),n,_(r,"seq")])},dot:function(n){var e=w(n),r=1;if(n[0]=="num"){if(!/[a-f.]/i.test(e))e+="."}else if(n[0]!="function"&&g(n))e="("+e+")";while(r<arguments.length)e+="."+a(arguments[r++]);return e},call:function(n,e){var r=w(n);var t=n[0]=="function"&&r.charAt(0)=="(";if(!t&&g(n))r="("+r+")";return r+"("+p(MAP(e,function(n){return _(n,"seq")}))+")"},function:y,defun:y,if:function(n,e,r){var t=["if","("+w(n)+")",r?m(e):w(e)];if(r){t.push("else",w(r))}return h(t)},for:function(n,e,r,t){var i=["for"];n=(n!=null?w(n):"").replace(/;*\s*$/,";"+u);e=(e!=null?w(e):"").replace(/;*\s*$/,";"+u);r=(r!=null?w(r):"").replace(/;*\s*$/,"");var s=n+e+r;if(s=="; ; ")s=";;";i.push("("+s+")",w(t));return h(i)},"for-in":function(n,e,r,t){return h(["for","("+(n?w(n).replace(/;+$/,""):w(e)),"in",w(r)+")",w(t)])},while:function(n,e){return h(["while","("+w(n)+")",w(e)])},do:function(n,e){return h(["do",w(e),"while","("+w(n)+")"])+";"},return:function(n){var e=["return"];if(n!=null)e.push(w(n));return h(e)+";"},binary:function(n,t,i){var u=w(t),s=w(i);if(member(t[0],["assign","conditional","seq"])||t[0]=="binary"&&PRECEDENCE[n]>PRECEDENCE[t[1]]||t[0]=="function"&&g(this)){u="("+u+")"}if(member(i[0],["assign","conditional","seq"])||i[0]=="binary"&&PRECEDENCE[n]>=PRECEDENCE[i[1]]&&!(i[1]==n&&member(n,["&&","||","*"]))){s="("+s+")"}else if(!r&&e.inline_script&&(n=="<"||n=="<<")&&i[0]=="regexp"&&/^script/i.test(i[1])){s=" "+s}return h([u,n,s])},"unary-prefix":function(n,e){var r=w(e);if(!(e[0]=="num"||e[0]=="unary-prefix"&&!HOP(OPERATORS,n+e[1])||!g(e)))r="("+r+")";return n+(jsp.is_alphanumeric_char(n.charAt(0))?" ":"")+r},"unary-postfix":function(n,e){var r=w(e);if(!(e[0]=="num"||e[0]=="unary-postfix"&&!HOP(OPERATORS,n+e[1])||!g(e)))r="("+r+")";return r+n},sub:function(n,e){var r=w(n);if(g(n))r="("+r+")";return r+"["+w(e)+"]"},object:function(n){var t=g(this);if(n.length==0)return t?"({})":"{}";var u="{"+i+c(function(){return MAP(n,function(n){if(n.length==3){return f(y(n[0],n[1][2],n[1][3],n[2],true))}var t=n[0],i=_(n[1],"seq");if(e.quote_keys){t=s(t)}else if((typeof t=="number"||!r&&+t+""==t)&&parseFloat(t)>=0){t=b(+t)}else if(!is_identifier(t)){t=s(t)}return f(h(r&&e.space_colon?[t,":",i]:[t+":",i]))}).join(","+i)})+i+f("}");return t?"("+u+")":u},regexp:function(n,r){if(e.ascii_only)n=to_ascii(n);return"/"+n+"/"+r},array:function(n){if(n.length==0)return"[]";return h(["[",p(MAP(n,function(e,t){if(!r&&e[0]=="atom"&&e[1]=="undefined")return t===n.length-1?",":"";return _(e,"seq")})),"]"])},stat:function(n){return n!=null?w(n).replace(/;*\s*$/,";"):";"},seq:function(){return p(MAP(slice(arguments),w))},label:function(n,e){return h([a(n),":",w(e)])},with:function(n,e){return h(["with","("+w(n)+")",w(e)])},atom:function(n){return a(n)},directive:function(n){return make_string(n)+";"}},function(){return w(n)});function m(n){if(n==null)return";";if(n[0]=="do"){return x([n])}var e=n;while(true){var r=e[0];if(r=="if"){if(!e[3])return w(["block",[n]]);e=e[3]}else if(r=="while"||r=="do")e=e[2];else if(r=="for"||r=="for-in")e=e[4];else break}return w(n)}function y(n,e,r,t,i){var u=t||"function";if(n){u+=" "+a(n)}u+="("+p(MAP(e,a))+")";u=h([u,x(r)]);return!i&&g(this)?"("+u+")":u}function P(n){switch(n[0]){case"with":case"while":return empty(n[2])||P(n[2]);case"for":case"for-in":return empty(n[4])||P(n[4]);case"if":if(empty(n[2])&&!n[3])return true;if(n[3]){if(empty(n[3]))return true;return P(n[3])}return P(n[2]);case"directive":return true}}function k(n,e){for(var t=[],i=n.length-1,u=0;u<=i;++u){var s=n[u];var a=w(s);if(a!=";"){if(!r&&u==i&&!P(s)){a=a.replace(/;+\s*$/,"")}t.push(a)}}return e?t:MAP(t,f)}function A(n){var e=n.length;if(e==0)return"{}";return"{"+i+MAP(n,function(n,t){var u=n[1].length>0,s=c(function(){return f(n[0]?h(["case",w(n[0])+":"]):"default:")},.5)+(u?i+c(function(){return k(n[1]).join(i)}):"");if(!r&&u&&t<e-1)s+=";";return s}).join(i)+i+f("}")}function x(n){if(!n)return";";if(n.length==0)return"{}";return"{"+i+c(function(){return k(n).join(i)})+i+f("}")}function M(n){var e=n[0],r=n[1];if(r!=null)e=h([a(e),"=",_(r,"seq")]);return e}}function split_lines(n,e){var r=[0];jsp.parse(function(){var t=jsp.tokenizer(n);var i=0;var u;function s(n){return n.pos-i}function a(n){i=n.pos;r.push(i)}function f(){var n=t.apply(this,arguments);n:{if(u){if(u.type=="keyword")break n}if(s(n)>e){switch(n.type){case"keyword":case"atom":case"name":case"punc":a(n);break n}}}u=n;return n}f.context=function(){return t.context.apply(this,arguments)};return f}());return r.map(function(e,t){return n.substring(e,r[t+1]||n.length)}).join("\n")}function repeat_string(n,e){if(e<=0)return"";if(e==1)return n;var r=repeat_string(n,e>>1);r+=r;if(e&1)r+=n;return r}function defaults(n,e){var r={};if(n===true)n={};for(var t in e)if(HOP(e,t)){r[t]=n&&HOP(n,t)?n[t]:e[t]}return r}function is_identifier(n){return/^[a-z_$][a-z0-9_$]*$/i.test(n)&&n!="this"&&!HOP(jsp.KEYWORDS_ATOM,n)&&!HOP(jsp.RESERVED_WORDS,n)&&!HOP(jsp.KEYWORDS,n)}function HOP(n,e){return Object.prototype.hasOwnProperty.call(n,e)}var MAP;(function(){MAP=function(t,i,u){var s=[],a=[],f;function c(){var c=i.call(u,t[f],f);if(c instanceof e){c=c.v;if(c instanceof r){a.push.apply(a,c.v)}else{a.push(c)}}else if(c!=n){if(c instanceof r){s.push.apply(s,c.v)}else{s.push(c)}}}if(t instanceof Array)for(f=0;f<t.length;++f)c();else for(f in t)if(HOP(t,f))c();return a.concat(s)};MAP.at_top=function(n){return new e(n)};MAP.splice=function(n){return new r(n)};var n=MAP.skip={};function e(n){this.v=n}function r(n){this.v=n}})();exports.ast_walker=ast_walker;exports.ast_mangle=ast_mangle;exports.ast_squeeze=ast_squeeze;exports.ast_lift_variables=ast_lift_variables;exports.gen_code=gen_code;exports.ast_add_scope=ast_add_scope;exports.set_logger=function(n){warn=n};exports.make_string=make_string;exports.split_lines=split_lines;exports.MAP=MAP;exports.ast_squeeze_more=require("./squeeze-more").ast_squeeze_more;